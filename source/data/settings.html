<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="style.css">
    <title>CoinThing Settings</title>
</head>

<body>

    <div class="jumbotron jumbotron-fluid">
        <div class="container">
            <h1 class="display-4">CoinThing</h1>
            <p class="lead">Settings</p>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="error_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title " id="error_modalLabel">Error occurred</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body text-danger">
                    <span id="error_text"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid text-center">
        <div class="row content">
            <div class="col-sm-2 sidenav">
            </div>
            <div class="col-sm-7 text-left">
                <form>
                    <div class="form-group">
                        <label for="coin"><b>Coin ID or symbol (e.g. bitcoin, btc)</b></label>
                        <input type="email" class="form-control" id="coin" placeholder="Coin Gecko ID">
                    </div>

                    <div class="form-group">
                        <label for="currency"><b>Currency (e.g. USD, EUR)</b></label>
                        <input type="email" class="form-control" id="currency" placeholder="Currency">
                    </div>

                    <div class="form-group">
                        <label><b>Number Format</b></label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="nf" id="nf_0" value="0">
                                <label class="form-check-label" for="nf_0">1.000,00</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="nf" id="nf_1" value="1">
                                <label class="form-check-label" for="nf_1">1&#x2006;000,00</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="nf" id="nf_2" value="2">
                                <label class="form-check-label" for="nf_2">1000,00</label>
                            </div>
                        </div>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="nf" id="nf_3" value="3">
                                <label class="form-check-label" for="nf_3">1,000.00</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="nf" id="nf_4" value="4">
                                <label class="form-check-label" for="nf_4">1&#x2006;000.00</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="nf" id="nf_5" value="5">
                                <label class="form-check-label" for="nf_5">1000.00</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><b>Chart</b></label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="co" id="co_0" value="0">
                                <label class="form-check-label" for="co_0">24 hour</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="co" id="co_1" value="1">
                                <label class="form-check-label" for="co_1">30 days</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="co" id="co_2" value="2">
                                <label class="form-check-label" for="co_2">both alternating</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><b>Heartbeat </b>&#x2764;</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="heartbeat" value="hb">
                                <label class="form-check-label" for="heartbeat">Heartbeat</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn btn-success mb-2" id="apply">Apply&nbsp;&nbsp;
                            <i class="fa fa-spinner fa-spin" id="applyspinner" style="visibility:hidden;"></i></button>
                    </div>

                </form>
            </div>
            <div class="col-sm-3 sidenav">
            </div>
        </div>
    </div>

    <footer class="footer bg-dark text-light ">
        <div class="container">
            &copy; 2020 barn53 &mdash; <a href="about.html">About</a>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <script type="text/javascript">

        function applyBusy(busy) {
            if (busy) {
                $("#apply").prop("disabled", true)
                $("#applyspinner").css("visibility", "visible")
            } else {
                $("#apply").prop("disabled", false)
                $("#applyspinner").css("visibility", "hidden")
            }
        }

        function getSettings() {
            $.get("/settings.json", function (data) {
                applyBusy(false)
                settings = JSON.parse(data)
                $("#coin").val(settings['coin'] || '')
                $("#currency").val(settings['currency'] || '')
                number_format = settings['number_format'] || 0
                chart = settings['chart'] || 0
                heartbeat = settings['heartbeat'] || 0
                try {
                    $("#nf_" + number_format)[0].checked = true
                } catch (error) { }
                try {
                    $("#co_" + chart)[0].checked = true
                } catch (error) { }
                try {
                    $("#heartbeat")[0].checked = (heartbeat !== 0)
                } catch (error) { }

                console.log(data)
            })
        }

        function showError(text) {
            $("#error_text").empty().append("Error " + text)
            $('#error_modal').modal({})
            applyBusy(false)
        }

        function checkFailed(e) {
            showError(e.responseText)
        }

        $(document).ready(function () {

            getSettings()

            $('#apply').off().click(function (e) {
                applyBusy(true)

                if (!$("#coin").val().match(/^[a-zA-Z0-9-]+$/)) {
                    showError(": Coin ID '" + $("#coin").val() + "' is invalid!")
                    return
                }
                if (!$("#currency").val().match(/^[a-zA-Z0-9-]+$/)) {
                    showError(": Currency value '" + $("#currency").val() + "' is invalid!")
                    return
                }
                number_format = -1
                if ($("#nf_0")[0].checked) {
                    number_format = 0
                } else if ($("#nf_1")[0].checked) {
                    number_format = 1
                } else if ($("#nf_2")[0].checked) {
                    number_format = 2
                } else if ($("#nf_3")[0].checked) {
                    number_format = 3
                } else if ($("#nf_4")[0].checked) {
                    number_format = 4
                } else if ($("#nf_5")[0].checked) {
                    number_format = 5
                }
                if (number_format === -1) {
                    showError(": Number format is not selected!")
                    return
                }

                chart = -1
                if ($("#co_0")[0].checked) {
                    chart = 0
                } else if ($("#co_1")[0].checked) {
                    chart = 1
                } else if ($("#co_2")[0].checked) {
                    chart = 2
                }
                if (chart === -1) {
                    showError(": Chart option is not selected!")
                    return
                }

                heartbeat = 0
                if ($("#heartbeat")[0].checked) {
                    heartbeat = 1
                }

                $.get("/action/set?coin=" + $("#coin").val()
                    + "&currency=" + $("#currency").val()
                    + "&number_format=" + number_format
                    + "&chart=" + chart + "&heartbeat=" + heartbeat, function (data) {

                        if (data === "1") {
                            getSettings()
                        } else {
                            showError(": " + data)
                        }

                    })
                    .fail(checkFailed)
                    .always(function () {
                        setTimeout(function () {
                            applyBusy(false)
                        }, 10000)
                    })
            })
        })

    </script>
</body>

</html>